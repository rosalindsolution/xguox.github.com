
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>XguoX</title>
    <meta name="author" content="XguoX">
    
	<meta name="description" content="Published on: Dec 26th, 2011 Tags: Jabber 这是我的第一篇Octopress Post,曾经很浅显简单的玩过一下Wordpress,因为部署问题后面没有继续.因为Octopress跟github的天然关系,我又开始玩独立博客了. &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="XguoX" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-39166710-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        XguoX
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/xguox" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/108737859837240042867?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  <!-- Flickr -->
  <li>
  <a href="http://www.flickr.com/photos/GroverLu" class="flickr" title="Flickr"></a>
  </li>
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/xguox_l" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2011/12/26/my-first-post-of-octopress/">
		
			Hello Octopress!</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-26T00:26:00+08:00" pubdate data-updated="true">Dec 26<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/jabber/'>Jabber</a>


</div>
    </div>
		<p>这是我的第一篇Octopress Post,曾经很浅显简单的玩过一下Wordpress,因为部署问题后面没有继续.因为Octopress跟github的天然关系,我又开始玩独立博客了.虽然我很想自己一边学习Rails一边搭建自己的博客框架,不过鉴于自己水平暂时还不够,再者秉承不重复造轮子的思想,于是用了octopress,并部署在github上.这是成功发表的第一篇,感谢来自Ruby on Rails 公园的<a href="http://googya.github.com/">@googya</a> 的小Tips.</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2011/12/26/my-first-post-of-octopress//blog/page/13/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2011/12/25/ror-performance/">
		
			加速 Ruby on Rails</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-25T17:14:00+08:00" pubdate data-updated="true">Dec 25<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/repost/'>Repost</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p><a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html">Repost</a></p>

<p>Ruby 语言常以其灵活性为人所称道.正如 Dick Sites 所言,您可以 &ldquo;为了编程而编程&rdquo;.Ruby on Rails 扩展了核心 Ruby 语言,但正是 Ruby 本身使得这种扩展成为了可能.Ruby on Rails 使用了该语言的灵活性,这样一来,无需太多样板或额外的代码就可以轻松编写高度结构化的程序:无需额外工作,就可以获得大量标准的行为.虽然这种轻松自由的行为并不总是完美的,但毕竟您可以无需太多工作就可以获得很多好的架构.</p>

<p>例如,Ruby on Rails 基于模型-视图-控制器(Model-View-Controller,MVC)模式,这意味着大多数 Rails 应用程序都可以清晰地分成三个部分.模型部分包含了管理应用程序数据所需的行为.通常,在一个 Ruby on Rails 应用程序中,模型和数据库表之间的关系是 1:1；Ruby on Rails 默认使用的对象关系映射(ORM)ActiveRecord 负责管理模型与数据库的交互,这意味着 Ruby on Rails 程序通常都具有(如果有的话)很少量的 SQL 代码.第二个部分是视图,它包含创建发送至用户的输出所需要的代码；它通常由 HTML、JavaScript 等组成.最后的一个部分是控制器,它将来自用户的输入转变为正确的模型,然后使用适当的视图呈现响应.</p>

<p>Rails 的倡导者通常都乐于将其易用性方面的提高归功于 MVC 范型 — 以及 Ruby 和 Rails 二者的其他一些特性,并称很少有程序员能够在较短的时间内创建更多的功能.当然,这意味着投入到软件开发的成本将能够产生更多的商业价值,因此 Ruby on Rails 开发愈发流行.</p>

<p>不过,最初的开发成本并不是事情的全部,还有其他的后续成本需要考虑,比如应用程序运行的维护成本和硬件成本.Ruby on Rails 开发人员通常会使用测试和其他的敏捷开发技术来降低维护成本,但是这样一来,很容易忽视具有大量数据的 Rails 应用程序的有效运行.虽然 Rails 能够简化对数据库的访问,但它并不总是能够如此有效.</p>

<h2>Rails 应用程序为何运行缓慢?</h2>

<p>Rails 应用程序之所以运行缓慢,其中有几个很基本的原因.第一个原因很简单:Rails 总是会做一些假设为您加速开发.通常,这种假设是正确而有帮助的.不过,它们并不总能有益于性能,并且还会导致资源使用的效率低下 — 尤其是数据库资源.</p>

<p>例如,使用等同于 <code>SELECT *</code>的一个 SQL 语句,ActiveRecord 会默认选择查询上的所有字段.在具有为数众多的列的情况下 — 尤其是当有些字段是巨大的 VARCHAR 或 BLOB 字段时 — 就内存使用和性能而言这种行为很有问题.</p>

<p>另一个显著的挑战是 <strong>N+1</strong> 问题,本文将对此进行详细的探讨.这会导致很多小查询的执行,而不是一个单一的大查询.例如,ActiveRecord 无从知道一组父记录中的哪一个会请求一个子记录,所以它会为每个父记录生成一个子记录查询.由于每查询的负荷,这种行为将导致明显的性能问题.</p>

<p>其他的挑战则更多地与  Ruby on Rails 开发人员的开发习惯和态度相关.由于 ActiveRecord 能够让如此众多的任务变得轻而易举,Rails 开发人员常常会形成 &ldquo;SQL 不怎样&rdquo; 的一种态度,即便在更适合使用 SQL 的时候,也会避免 SQL.创建和处理数量巨大的 ActiveRecord 对象的速度会非常缓慢,所以在有些情况下,直接编写一个无需实例化任何对象的 SQL 查询会更快些.</p>

<p>由于 Ruby on Rails 常被用来降低开发团队的规模,又由于 Ruby on Rails 开发人员通常都会执行部署和维护生产中的应用程序所需的一些系统管理任务,因此若对应用程序的环境知之甚少,就很可能出问题.操作系统和数据库有可能未被正确设置.比如,虽然并不最优,<code>MySQL my.cnf</code> 设置常常在 Ruby on Rails 部署内保留它们的默认设置.此外,可能还会缺少足够的监控和基准测试工具来提供性能的长期状况.当然,这并不是在责怪 Ruby on Rails 开发人员；这是非专业化导致的后果；在有些情况下,Rails 开发人员有可能是这两个领域的专家.</p>

<p>最后一个问题是 Ruby on Rails 鼓励开发人员在本地环境中进行开发.这么做有几个好处 — 比如,开发延迟的减少和分布性的提高 — 但它并不意味着您可以因为工作站规模的减少而只处理有限的数据集.他们如何开发以及代码将被部署于何处之间的差异可能会是一个大问题.即便您在一个性能良好的轻载本地服务器上处理小规模的数据已经很长一段时间,也会发现对于拥塞的服务器上的大型数据此应用程序会有很明显的性能问题.</p>

<p>当然,Rails 应用程序具有性能问题的原因可能有很多.查出 Rails 应用程序有何潜在性能问题的最佳方法是,利用能为您提供可重复、准确度量的诊断工具.</p>

<h2>检测性能问题</h2>

<p>最好的工具之一是 Rails 开发日志,它通常位于每个开发机器上的 <code>log/development.log</code> 文件内.它具有各种综合指标:响应请求所花费的总时间、花费在数据库内的时间所占的百分比、生成视图所花时间的百分比等.此外,还有一些工具可用来分析此日志文件,比如 development-log-analyzer.</p>

<p>在生产期间,通过查看 <code>mysql_slow_log</code>可以找到很多有价值的信息.更为全面的介绍超出了本文的讨论范围,更多信息可以在 <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">参考资料 </a>部分找到.</p>

<p>其中一个最强大也是最为有用的工具是 query_reviewer 插件(参见 <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">参考资料</a>).这个插件可显示在页面上有多少查询在执行以及页面生成需要多长时间.并且它还会自动分析 ActiveRecord 生成的 SQL 代码以便发现潜在问题.例如,它能找到不使用 MySQL 索引的查询,所以如果您忘记了索引一个重要的列并由此造成了性能问题,那么您将能很容易地找到这个列(有关 MySQL 索引的更多信息,参见 <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">参考资料</a>).此插件在一个弹出的 <code>&lt;div&gt;</code>(只在开发模式下可见)中显示了所有这类信息.</p>

<p>最后,不要忘记使用类似 Firebug、yslow、Ping 和 tracert 这样的工具来检测性能问题是来自于网络还是资源加载问题.</p>

<p>接下来,让我们来看具体的一些 Rails 性能问题及其解决方案.</p>

<h2>N+1 查询问题</h2>

<p>N+1 查询问题是 Rails 应用程序最大的问题之一.例如,清单 1 内的代码能生成多少查询?此代码是一个简单的循环,遍历了一个假想的 post 表内的所有 post,并显示 post 的类别和它的主体.</p>

<h3>清单 1. 未优化的 Post.all 代码</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%@posts = Post.all(@</span><span class="n">posts</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span><span class="sx">%&gt; </span>
</span><span class='line'><span class="sx">  &lt;h1&gt;</span><span class="o">&lt;</span><span class="sx">%=p.category.name%&gt;&lt;/h1&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;&lt;%=</span><span class="nb">p</span><span class="o">.</span><span class="n">body</span><span class="sx">%&gt;&lt;/p&gt;</span>
</span><span class='line'><span class="o">&lt;%</span><span class="k">end</span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>答案:上述代码生成了一个查询外加  <code>@posts</code> 内的每行一个查询.由于每查询的负荷,这可能会成为一个很大的挑战.罪魁祸首是对 <code>p.category.name</code> 的调用.这个调用只应用于该特定的 <code>post</code> 对象,而不是整个 <code>@posts</code> 数组.幸好,通过使用立即加载,我们可以修复这个问题.</p>

<p>立即加载 意味着 Rails 将自动执行所需的查询来加载任何特定子对象的对象.Rails 将使用一个 <code>JOIN</code> SQL 语句或一个执行多个查询的策略.不过,假设指定了将要使用的所有子对象,那么将永远不会导致 N+1 的情形,在 N+1 情形下,一个循环的每个迭代都会生成额外的一个查询.清单 2 是对 清单 1 内代码的修订,它使用了立即加载来避免 N+1 问题.</p>

<h3>清单 2. 用立即加载优化后的 Post.all 代码</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%@posts = Post.find(:all, :include=&gt;[:category]</span>
</span><span class='line'><span class="sx">  @</span><span class="n">posts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span><span class="sx">%&gt; </span>
</span><span class='line'><span class="sx">  &lt;h1&gt;</span><span class="o">&lt;</span><span class="sx">%=p.category.name%&gt;&lt;/h1&gt;</span>
</span><span class='line'><span class="sx">  &lt;p&gt;&lt;%=</span><span class="nb">p</span><span class="o">.</span><span class="n">body</span><span class="sx">%&gt;&lt;/p&gt;</span>
</span><span class='line'><span class="o">&lt;%</span><span class="k">end</span><span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>该代码最多生成两个查询,而不管在此 <code>posts</code> 表内有多少行.</p>

<p>当然,并不是所有情况都如此简单.处理复杂的 N+1 查询情况需要更多的工作.那么做这么多努力值得么?让我们来做一些快速的测试.</p>

<h2>测试 N+1</h2>

<p>使用清单 3 内的脚本,可以发现查询可以达到 — 多慢 — 或多快. 清单 3 展示了如何在一个独立脚本中使用 ActiveRecord 来建立一个数据库连接、定义表并加载数据.然后,可以使用 Ruby 的内置基准测试库来查看哪种方式更快,快多少.</p>

<h3>清单 3. 立即加载基准测试脚本</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;Rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;faker&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;active_record&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This call creates a connection to our database.</span>
</span><span class='line'>
</span><span class='line'><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span><span class="o">.</span><span class="n">establish_connection</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:adapter</span>  <span class="o">=&gt;</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:host</span>     <span class="o">=&gt;</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="c1"># Note that while this is the default setting for MySQL,</span>
</span><span class='line'>  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>     <span class="c1"># a properly secured system will have a different MySQL</span>
</span><span class='line'>                            <span class="c1"># username and password, and if so, you&#39;ll need to</span>
</span><span class='line'>                            <span class="c1"># change these settings.</span>
</span><span class='line'>  <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># First, set up our database... </span>
</span><span class='line'><span class="k">class</span> <span class="nc">Category</span> <span class="o">&lt;</span>  <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">unless</span> <span class="no">Category</span><span class="o">.</span><span class="n">table_exists?</span>
</span><span class='line'>  <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Schema</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:categories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>        <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="s1">&#39;Sara Campbell\&#39;s Stuff&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="s1">&#39;Jake Moran\&#39;s Possessions&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">Category</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="s1">&#39;Josh\&#39;s Items&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">number_of_categories</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Item</span> <span class="o">&lt;</span>  <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:category</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># If the table doesn&#39;t exist, we&#39;ll create it.</span>
</span><span class='line'>
</span><span class='line'><span class="k">unless</span> <span class="no">Item</span><span class="o">.</span><span class="n">table_exists?</span>
</span><span class='line'>  <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Schema</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:items</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>        <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>        <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:category_id</span><span class="p">,</span> <span class="ss">:integer</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Loading data...&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">item_count</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'><span class="n">item_table_size</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">item_count</span> <span class="o">&lt;</span> <span class="n">item_table_size</span>
</span><span class='line'>  <span class="p">(</span><span class="n">item_table_size</span> <span class="o">-</span> <span class="n">item_count</span><span class="p">)</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Item</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="no">Faker</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>                 <span class="ss">:category_id</span><span class="o">=&gt;</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">rand</span><span class="p">(</span><span class="n">number_of_categories</span><span class="o">.</span><span class="n">to_i</span><span class="p">)))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Running tests...&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="o">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">10000</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">size</span><span class="o">|</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">report</span> <span class="s2">&quot;size:</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">, with n+1 problem&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@items</span><span class="o">=</span><span class="no">Item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:limit</span><span class="o">=&gt;</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@items</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="n">i</span><span class="o">.</span><span class="n">category</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">x</span><span class="o">.</span><span class="n">report</span> <span class="s2">&quot;size:</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">, with :include&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@items</span><span class="o">=</span><span class="no">Item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:include</span><span class="o">=&gt;</span><span class="ss">:category</span><span class="p">,</span> <span class="ss">:limit</span><span class="o">=&gt;</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@items</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="n">i</span><span class="o">.</span><span class="n">category</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个脚本使用 <code>:include</code> 子句测试在有和没有立即加载的情况下对 100、1,000 和 10,000 个对象进行循环操作的速度如何.为了运行此脚本,您可能需要用适合于您的本地环境的参数替换此脚本顶部的这些数据库连接参数.此外,需要创建一个名为 test 的 MySQL 数据库.最后,您还需要 ActiveRecord 和 faker 这两个 gem,二者可通过运行 <code>gem install activerecord faker</code> 获得.</p>

<p>在我的机器上运行此脚本生成的结果如清单 4 所示.</p>

<h3>清单 4. 立即加载的基准测试脚本输出</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">--</span> <span class="n">create_table</span><span class="p">(</span><span class="ss">:categories</span><span class="p">)</span>
</span><span class='line'>   <span class="o">-&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1327</span><span class="n">s</span>
</span><span class='line'><span class="o">--</span> <span class="n">create_table</span><span class="p">(</span><span class="ss">:items</span><span class="p">)</span>
</span><span class='line'>   <span class="o">-&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1215</span><span class="n">s</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">data</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="no">Running</span> <span class="n">tests</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>      <span class="n">user</span>     <span class="nb">system</span>      <span class="n">total</span>        <span class="n">real</span>
</span><span class='line'><span class="ss">size</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="n">with</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="n">problem</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">030000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">030000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">045</span><span class="mi">996</span><span class="p">)</span>
</span><span class='line'><span class="ss">size</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="n">with</span> <span class="ss">:include</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">010000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">010000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="mi">9164</span><span class="p">)</span>
</span><span class='line'><span class="ss">size</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span> <span class="n">with</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="n">problem</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">260000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">040000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">300000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">346721</span><span class="p">)</span>
</span><span class='line'><span class="ss">size</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span> <span class="n">with</span> <span class="ss">:include</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">060000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">010000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">070000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mo">07673</span><span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="ss">size</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span> <span class="n">with</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="n">problem</span>  <span class="mi">3</span><span class="o">.</span><span class="mi">110000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">380000</span>   <span class="mi">3</span><span class="o">.</span><span class="mi">490000</span> <span class="p">(</span>  <span class="mi">3</span><span class="o">.</span><span class="mi">935518</span><span class="p">)</span>
</span><span class='line'><span class="ss">size</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span> <span class="n">with</span> <span class="ss">:include</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">470000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">080000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">550000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">573861</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>在所有情况下,使用 :include 的测试总是更为迅速 — 分别快 5.02、4.52 和 6.86 倍.当然,具体的输出取决于您的特定情况,但立即加载可明显导致显著的性能改善.</p>

<h2>嵌套的立即加载</h2>

<p>如果您想要引用一个嵌套的关系 — 关系的关系,又该如何呢? 清单 5 展示了这样一个常见的情形:循环遍历所有的 post 并显示作者的图像,其中 Author 与 Image 是 belongs_to 的关系.</p>

<h3>清单 5. 嵌套的立即加载用例</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'><span class="vi">@posts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;&lt;</span><span class="sx">%=p.category.name%&gt;&lt;/h1&gt;</span>
</span><span class='line'><span class="sx">  &lt;%=</span><span class="n">image_tag</span> <span class="nb">p</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">public_filename</span> <span class="sx">%&gt; </span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span><span class="o">&lt;%=</span><span class="nb">p</span><span class="o">.</span><span class="n">body</span><span class="sx">%&gt; </span>
</span><span class='line'><span class="sx"> &lt;%end%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>此代码与之前一样亦遭遇了相同的 N+1 问题,但修复的语法却没有那么明显,因为这里所使用的是关系的关系.那么如何才能立即加载嵌套关系呢?</p>

<p>正确的答案是使用 <code>:include</code> 子句的哈希语法.清单 6 给出了使用哈希语法的一个嵌套的立即加载.</p>

<h3>清单 6. 嵌套的立即加载解决方案</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:include</span><span class="o">=&gt;</span><span class="p">{</span> <span class="ss">:category</span><span class="o">=&gt;[]</span><span class="p">,</span>
</span><span class='line'>                                       <span class="ss">:author</span><span class="o">=&gt;</span><span class="p">{</span> <span class="ss">:image</span><span class="o">=&gt;[]</span><span class="p">}}</span> <span class="p">)</span>
</span><span class='line'><span class="vi">@posts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;&lt;</span><span class="sx">%=p.category.name%&gt;&lt;/h1&gt;</span>
</span><span class='line'><span class="sx">  &lt;%=</span><span class="n">image_tag</span> <span class="nb">p</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">public_filename</span> <span class="sx">%&gt; </span>
</span><span class='line'><span class="sx">  &lt;p&gt;</span><span class="o">&lt;%=</span><span class="nb">p</span><span class="o">.</span><span class="n">body</span><span class="sx">%&gt; </span>
</span><span class='line'><span class="sx"> &lt;%end%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>正如您所见,您可以嵌套哈希和数组实量(literal).请注意在本例中哈希和数组之间的惟一区别是哈希可以含有嵌套的子条目,而数组则不能.否则,二者是等效的.</p>

<h2>间接的立即加载</h2>

<p>并非所有的 N+1 问题都能很容易地察觉到.例如,清单 7 能生成多少查询?</p>

<h3>清单 7. 间接的立即加载示例用例</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">&lt;</span><span class="sx">%@user = User.find(5)</span>
</span><span class='line'><span class="sx">    @</span><span class="n">user</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span><span class="sx">%&gt;   </span>
</span><span class='line'><span class="sx">      &lt;%=render :partial=&gt;</span><span class="s1">&#39;posts/summary&#39;</span><span class="p">,</span>  <span class="ss">:locals</span><span class="o">=&gt;</span><span class="ss">:post</span><span class="o">=&gt;</span><span class="nb">p</span>
</span><span class='line'>     <span class="sx">%&gt; &lt;%end%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然,决定查询的数量需要对 <code>posts/summary</code> partial 有所了解.清单 8 中显示了这个 partial.</p>

<h3>清单 8. 间接立即加载 partial: posts/_summary.html.erb</h3>

<p>  <code>&lt;h1&gt;&lt;%=post.user.name%&gt;&lt;/h1&gt;</code>
不幸的是,答案是 <strong>清单 7</strong><em> 和 <strong>清单 8</strong></em> 在 post 内每行生成一个额外查询,查找用户的名字 — 即便 post 对象由 ActiveRecord 从一个已在内存中的 User 对象自动生成.简言之,Rails 并不能关联子记录与其父记录.<br/>
修复方法是使用自引用的立即加载.基本上,由于 Rails 重载由父记录生成的子记录,所以需要立即加载这些父记录,就如同父与子记录之间是完全分开的关系一样.代码如清单 9 所示.</p>

<h3>清单 9. 间接的立即加载解决方案</h3>

<p>  <code>ruby
  &lt;%@user = User.find(5, :include=&gt;{:posts=&gt;[:user]})
  ...snip...
 </code></p>

<p>虽然有悖于直觉,但这种技术与上述技术的工作原理大致相似.但是,很容易使用这种技术进行过多的嵌套,尤其是在体系结构复杂的情况下.简单的用例还好,比如 清单 9 内所示的,但繁复的嵌套也会出问题.在一些情况下,过多地加载 Ruby 对象有可能会比处理 N+1 问题还要缓慢 — 尤其是当每个对象并没有被整个树遍历时.在该种情况下,N+1 问题的其他解决方案可能更为适合.</p>

<p>一种方式是使用缓存技术.Rails V2.1 内置了简单的缓存访问.使用 Rails.cache.read、 Rails.cache.write 及相关方法,可以轻松创建自己的简单缓存机制,并且后端可以是一个简单的内存后端、一个基于文件的后端或一个分布式缓存服务器.在 <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">参考资料</a> 部分可以找到有关 Rails 内置缓存支持的更多信息.但您无需创建自己的缓存解决方案；您可以使用一个预置的 Rails 插件,比如 Nick Kallen 的 cache money 插件.这个插件提供了 write-through 缓存并以 Twitter 上使用的代码为基础.更多信息参见 <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">参考资料</a>.</p>

<p>当然,并不是所有的 Rails 问题都与查询的数量有关.</p>

<h2>Rails 分组和聚合计算</h2>

<p>您可能遇到的一个问题是在 Ruby 所做的工作本应由数据库完成.这考验了 Ruby 的强大程度.很难想象在没有任何重大激励的情况下人们会自愿在 C 中重新实现其数据库代码的各个部分,但很容易在 Rails 内对 ActiveRecord 对象组进行类似的计算.但是,Ruby 总是要比数据库代码慢.所以请不要使用纯 Ruby 的方式执行计算,如清单 10 所示.</p>

<h3>清单 10. 执行分组计算的不正确方式</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">all_ages</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:age</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">uniq</span>
</span><span class='line'>  <span class="n">oldest_age</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
</span></code></pre></td></tr></table></div></figure>


<p>相反,Rails 提供了一系列的分组和聚合函数.可以像清单 11 所示的那样使用它们.</p>

<h3>清单 11. 执行分组计算的正确方式</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">all_ages</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:group</span><span class="o">=&gt;[</span><span class="ss">:age</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">oldest_age</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">calcuate</span><span class="p">(</span><span class="ss">:max</span><span class="p">,</span> <span class="ss">:age</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ActiveRecord::Base#find 有大量选项可用于模仿 SQL.更多信息可以在 Rails 文档内找到.注意,calculate 方法可适用于受数据库支持的任何有效的聚合函数,比如 <code>:min</code>、<code>:sum</code> 和 <code>:avg</code>.此外,calculate 能够接受若干实参,比如 <code>:conditions</code>.查阅 Rails 文档以获得更详细的信息.</p>

<p>不过,并不是在 SQL 内能做的所有事情在 Rails 内也能做.如果插件不够,可以使用定制 SQL.</p>

<h2>用 Rails 定制 SQL</h2>

<p>假设有这样一个表,内含人的职业、年龄以及在过去一年中涉及到他们的事故的数量.可以使用一个定制  SQL 语句来检索此信息,如清单 12 所示.</p>

<h3>清单 12. 用 ActiveRecord 定制 SQL 的例子</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT profession,</span>
</span><span class='line'><span class="s2">              AVG(age) as average_age,  </span>
</span><span class='line'><span class="s2">              AVG(accident_count) </span>
</span><span class='line'><span class="s2">         FROM persons </span>
</span><span class='line'><span class="s2">        GROUP </span>
</span><span class='line'><span class="s2">           BY profession&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Person</span><span class="o">.</span><span class="n">find_by_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">row</span><span class="o">.</span><span class="n">profession</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="o">&lt;&lt;</span>
</span><span class='line'>       <span class="s2">&quot;avg. age: </span><span class="si">#{</span><span class="n">row</span><span class="o">.</span><span class="n">average_age</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="o">&lt;&lt;</span>
</span><span class='line'>       <span class="s2">&quot;avg. accidents: </span><span class="si">#{</span><span class="n">row</span><span class="o">.</span><span class="n">average_accident_count</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个脚本应该能生成清单 13 所示的结果.</p>

<h3>清单 13. 用 ActiveRecord 定制 SQL 的输出</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Programmer</span><span class="p">,</span> <span class="n">avg</span><span class="o">.</span> <span class="ss">age</span><span class="p">:</span> <span class="mi">18</span><span class="o">.</span><span class="mo">010</span><span class="p">,</span> <span class="n">avg</span><span class="o">.</span> <span class="ss">accidents</span><span class="p">:</span> <span class="mi">9</span>
</span><span class='line'>  <span class="no">System</span> <span class="no">Administrator</span><span class="p">,</span> <span class="n">avg</span><span class="o">.</span> <span class="ss">age</span><span class="p">:</span> <span class="mi">22</span><span class="o">.</span><span class="mi">720</span><span class="p">,</span> <span class="n">avg</span><span class="o">.</span> <span class="ss">accidents</span><span class="p">:</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然,这是最简单的例子.您可以自己想象一下如何能将此例中的 SQL 扩展成一个有些复杂性的 SQL 语句.您还可以使用 <code>ActiveRecord::Base.connection.execute</code> 方法运行其他类型的 SQL 语句,比如 ALTER TABLE 语句,如清单 14 所示.</p>

<h3>清单 14. 用 ActiveRecord 定制非查找型 SQL</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span> <span class="s2">&quot;ALTER TABLE some_table CHANGE COLUMN...&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>大多数的模式操作,比如添加和删除列,都可以使用 Rails 的内置方法完成.但如果需要,也可以使用执行任意 SQL 代码的能力.</p>

<h2>结束语</h2>

<p>与所有的框架一样,如果不多加小心和注意,Ruby on Rails 也会遭遇性能问题.所幸的是,监控和修复这些问题的技术相对简单且易学,而且即便是复杂的问题,只要有耐心并对性能问题的源头有所了解,也是可以解决的.</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2011/12/25/ror-performance//blog/page/13/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2011/12/23/20131224-guangzhou/">
		
			Diary:2011-12-23在妖都的一天</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-23T17:29:00+08:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/diary/'>Diary</a>, <a class='category' href='/blog/categories/jabber/'>Jabber</a>


</div>
    </div>
		<p>总有人问,XXX跟YYY那个地方比较好玩.其实我觉得都要自己走过了才能评价,而且别人的评价不一定适合你.再说,我觉得城市跟城市没啥好比较的,各有各的风格韵味.而在一个城市里边不同的地方风格韵味也不一样.</p>

<p>在妖都呆了两年多了,都木有怎么好好的走过.除了偶尔去其他同学的学校串串门,跑到北京路上下九这些走过N遍的街,再在天河城岗顶那些大商场转悠(虽说妖都的消费是贵,但是没人强迫你买东西撒,window shopping也不错的,还可以去一些什么苹果佳能数码体验店把玩下)&hellip;</p>

<p>记得之前去过最文艺的应该是小洲村了.&ldquo;流泪的咖啡&rdquo;,&ldquo;难喝的奶茶&rdquo;,&ldquo;蜜蜂喝过的绿茶&rdquo;&ldquo;三夏光年&rdquo;&hellip;嗯,想想现在好想到回去再瞧瞧&hellip;</p>

<p>因为烦闷了一个星期的考试,接着还要做各种课程设计,期末的小日子各种苦逼,于是昨天自己一个人一个包一部相机出门转悠去.</p>

<p>昨天的装束,让我觉得自己是一个像广州人的非广州人,像旅行者的常住者.背着包拿着相机四处张望,有种旅行者的范儿,但是熟练的搭地铁公交以及还算不错的粤语,又似乎,我就是一个地道的广州人.</p>

<p>第一站是&mdash;-方所书店&mdash;-貌似是11月末开张的&hellip;因为其文艺的气息让我慕名而来.其实我并不知道它的具体位置,只知道到地铁出口附近,跟着直觉走了几步居然就发现了.这并不是一个纯粹的书店,它融入了服侍cafe这些元素&hellip;最喜欢的是它的灯光,昏黄而富有情调.一开始我并没怎么放开,甚至有些蹑手蹑脚的,因为感觉在书店里摄影不太好,后来问过店员,他说&#8221;只要不要是靠近拍特写的那种,远远的拍是可以的&#8221;.最开始拍出来的那几张都没有那种调调和气息.后来把白平衡设置为日光后好多了.这里有许多来自港台国外的书籍,对于哪那一类的文艺青年,这里可以败到许多其他地方所没有的书籍.其实我并不是一个真正的文艺青年,对那些很文艺的青年大众小说不怎么带感.尽管这里很多的书并不适合我,不过还是看到好几本想要的书,好吧,期末的孩纸穷了,下次再来&hellip;一路充满我大脑的就两个字,文艺.重复的转悠了好几圈,也始终没有想要离开的欲望,若不是后面还有行程我想我可以花一个下午一整天的时间在这里.</p>

<p>离开方所直奔圣心教堂,走出海珠广场的地铁口,原本想凭直觉找到教堂的,但是失败了.最后不得不借助GPS&hellip;圣心教堂坐落在很多房屋中间,按照GPS的路线走了会才看到远处有一幢建筑的设计很特别.远远就看到了教堂的尖顶了.教堂内是不允许别人拍照的,但是进去之后貌似没人管理就偷偷拍了几张,后来,管理的阿姨从外面冲进来阻止了我们,有那么5~6个是光明正大的在拍.好吧,我觉得自己邪恶的玷污了教堂的神圣.所以没太用心去感受.有人说圣心比澳门的任何一间教堂都要宏伟&hellip;呃,我在澳门看过的教堂也不多,还是不做比较了.或者说,因为没有对教堂有什么认识,感觉都差不多吧.</p>

<p>在方所我尝试了各种白平衡,在圣心,则练习了各种曝光补偿&hellip; 好多时候,同一张照片拍了好多次,一级级的补偿直到满意为止.</p>

<p>我是个依赖地铁的人&mdash;-接下来是沙面,直转黄沙站.出站后依旧是凭着直觉的找到了.先是登上天桥四处张望,发现沙面的那个方向的建筑似乎比较的不同,而且人流相对来说比较旺盛一些.如果不是为了摄影我想我不会单独一个人跑来这里,并不是这里有什么不好,只是感觉这里适合跟朋友情人来,总之有伴儿来这会好一些.接近傍晚时分,测光各种出问题,我想我还是不太会利用光线.主要是这里的建筑都是欧式比较特殊吧,路上还遇上不少新人在拍摄结婚照片.我没有举起自己的相机也跟着拍,主要是因为,这些结婚的人跟我没啥关系,不管我最后照的好或坏,对我来说意义都不太深刻.当时,作为练习拍摄那个就另说吧&hellip;</p>

<p>冬日的5~6点真的没什么光线了,我也启程下一站.说实话,那时候的我真的好累,走了一整天还背着部单反.好吧,你们就说我的体质弱爆了吧.比较遗憾的是,这次出门身上带的钱不多,充了个羊城通就所剩无几了,所以没怎么尝到各地小食.连饭都没吃,饿啊&hellip;到了体育西站的时候,我在犹豫是直接回学校还是继续呢?话说当时地铁里那个人多啊,用举步维艰形容也不为过.最终,我还是决定坚持吧,反正都累了一整天不差继续累多会.于是来到了海心沙这边,这是我第二次来.也是我第一次单独一个人来.走出地铁时候外面天色已是完全的暗了!这里依旧的繁华,各种灯光扑朔迷离.因为临近圣诞,更加的热闹了.据说今晚貌似有节目,各种黄牛党在路上&#8221;要不要票,最低198啊..&ldquo;网上说有巨大的圣诞树看,不过貌似要门票进去,而且也不怎么巨吧.好想带个三脚架来这,夜晚手持拍摄始终不蛋定啊.直到那时我才发现,今天我的视角都是在地平线,啥时候找个高楼我想一定很壮观.只能等下次了&hellip;真的好累</p>

<p>尽管今天看似走了好多地方,但其实也仅仅是广州一角,我想,偌大一个城市,一定还有很多我没见到而很想见的地方.</p>

<p>相片在flickr,为自己的flickr打个小广告:<a href="http://www.flickr.com/photos/groverlu/">http://www.flickr.com/photos/groverlu/</a></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2011/12/23/20131224-guangzhou//blog/page/13/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2011/12/08/error-rails-3-dot-1/">
		
			伤不起的Rails 3.1</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-12-08T17:14:00+08:00" pubdate data-updated="true">Dec 8<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>Rails</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>Maybe很多ror新人如我会跟着那个<a href="http://guides.RubyonRails.org/">Rails guide</a>小试牛刀搭一个自己的blog.一步步下来小有体会到Rails的强劲,也没出啥问题,到的comment那一块,X,对了半天源代码甚至复制粘贴到Sublime Text,奈何还是坑爹的冒出错误:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>undefined method `error_messages' for #&lt;ActionView::Helpers::FormBuilder:0x3bff910&gt;</span></code></pre></td></tr></table></div></figure>


<p>嗯,好吧,简体和繁体的guide都是基于Rails 3.0的.于是去官方看了下Rails 3.1的那个guide.很明显的,源代码少了<br/>
<code>"&lt;%= f.error_messages %&gt;"</code><br/>
这一行.删去后妥妥的&hellip;.<br/>
查了下<code>error_messages</code>这玩意的用处,没查到,有木有高端指教一下啊~~<br/>
好吧,顺便借机叹息一下,中文的ror资料更新的好慢啊,想看中文版的AWDWR第四版却迟迟不出.难不成真的要去看英文版的??最近看 github上的英文已经各种够吃力了!!<del>(>_&lt;)</del></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2011/12/08/error-rails-3-dot-1//blog/page/13/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2011/11/18/proc-vs-lambda/">
		
			Lambda 和 Proc 的区别在哪儿</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-18T17:12:00+08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>proc是代码块的对象形式,它的行为就像一个代码块.Lambda的的行为略有不同,它的行为更像方法而非代码块.调用一个proc则像对代码块进行yield,而调用一个lambda则像调用一个方法.在Ruby1.9中的,可以通过Proc对象的实例方法 lambda? 来判定该实例是一个proc还是lambda,如果返回值为真,那么它是一个lambda,否则为一个proc.</p>

<h2>代码块、proc和lambda中的return语句</h2>

<p>在一个代码块中的return语句不仅仅会从调用代码块的迭代器返回,它还会从调用迭代器的方法返回.例如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span>  <span class="nf">test</span>
</span><span class='line'>     <span class="nb">puts</span> <span class="s2">&quot;entering method&quot;</span>
</span><span class='line'>     <span class="mi">1</span><span class="o">.</span><span class="n">times</span><span class="p">{</span><span class="nb">puts</span> <span class="s2">&quot;entering block&quot;</span><span class="p">;</span><span class="k">return</span><span class="p">}</span>
</span><span class='line'>     <span class="nb">puts</span> <span class="s2">&quot;exiting method&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>proc与代码块类似,因此如果调用的proc执行一个return语句,它会试图从代码块(这个代码块被转换为一个proc)所在的方法中返回.比如:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="k">def</span>  <span class="nf">test</span>
</span><span class='line'>            <span class="nb">puts</span> <span class="s2">&quot;entering method&quot;</span>
</span><span class='line'>            <span class="nb">p</span> <span class="o">=</span><span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="nb">puts</span>  <span class="s2">&quot;entering proc&quot;</span><span class="p">;</span><span class="k">return</span><span class="p">}</span>
</span><span class='line'>            <span class="nb">p</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>            <span class="nb">puts</span> <span class="s2">&quot;exiting method&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>不过,因为proc经常在不同方法间传递,在proc中使用return语句会十分诡异.在proc被调用时,在句法上包含该proc的方法已经返回:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="k">def</span>   <span class="nf">procBuilder</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>            <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="nb">puts</span> <span class="n">message</span> <span class="p">;</span><span class="k">return</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span>   <span class="nf">test</span>
</span><span class='line'>            <span class="nb">puts</span> <span class="s2">&quot;entering method&quot;</span>
</span><span class='line'>            <span class="nb">p</span> <span class="o">=</span> <span class="n">procBuilder</span><span class="p">(</span><span class="s2">&quot;entering proc&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">p</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>            <span class="nb">puts</span> <span class="s2">&quot;exiting method&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>在把代码块转换成对象后,可以四处传递该对象,并且在&#8221;上下文&#8221;之外使用.如果这样做,则要承担从一个已经返回的方法中返回的风险.就像本例所示那样.当这种情况发生时,Ruby会抛出一个LocalJumpError异常.</p>

<p>当然,在这个臆造的例子中,可以通过去掉多余的return语句来修复这个问题.不过return语句并非总是多余的,这时可以通过使用lambda而非proc来修复这个问题.如前所述,lambda更像方法而非代码块.这样,在lambda中的return语句仅仅从lambda自身返回.而不会从产生lambda的方法中返回:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="k">def</span>  <span class="nf">test</span>
</span><span class='line'>            <span class="nb">puts</span> <span class="s2">&quot;entering method&quot;</span>
</span><span class='line'>            <span class="nb">p</span> <span class="o">=</span> <span class="nb">lambda</span><span class="p">{</span><span class="nb">puts</span>  <span class="s2">&quot;entering lambda&quot;</span><span class="p">;</span><span class="k">return</span><span class="p">}</span>
</span><span class='line'>            <span class="nb">p</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>            <span class="nb">puts</span> <span class="s2">&quot;exiting method&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lambda中的return仅仅从lambda自身返回,这个事实意味着我们根本无须考虑LocalJumpError;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="k">def</span>  <span class="nf">lambdaBuilder</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">lambda</span> <span class="p">{</span><span class="nb">puts</span> <span class="n">message</span><span class="p">;</span><span class="k">return</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span>  <span class="nf">test</span>
</span><span class='line'>            <span class="nb">puts</span>   <span class="s2">&quot;exiting method&quot;</span>
</span><span class='line'>            <span class="n">l</span> <span class="o">=</span><span class="n">lambdaBuilder</span><span class="p">(</span><span class="s2">&quot;entering lambda&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">l</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>            <span class="nb">puts</span>  <span class="s2">&quot;exiting method&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<h2>代码块、proc和lambda中的break语句</h2>

<p>当我们用Proc.new创建一个proc对象时,这个Proc.new就是break语句应该返回的地方,当我们调用proc对象的时候,这个迭代器已经返回了,因此,用Proc.new创建一个顶级break语句是说不通的:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>            <span class="k">def</span>  <span class="nf">test</span>
</span><span class='line'>                    <span class="nb">puts</span>  <span class="s2">&quot;entering test method &quot;</span>
</span><span class='line'>                    <span class="nb">proc</span> <span class="o">=</span><span class="no">Proc</span><span class="o">.</span><span class="n">new</span><span class="p">{</span><span class="nb">puts</span> <span class="s2">&quot;entering proc&quot;</span><span class="p">;</span><span class="k">break</span><span class="p">}</span>
</span><span class='line'>                    <span class="nb">proc</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>                    <span class="nb">puts</span>  <span class="s2">&quot;exiting test method&quot;</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果通过迭代器方法的&amp;参数方式创建一个proc,我们可以调用它让该迭代器方法返回；</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>            <span class="k">def</span>  <span class="nf">iterator</span> <span class="p">(</span><span class="o">&amp;</span><span class="nb">proc</span><span class="p">)</span>
</span><span class='line'>                    <span class="nb">puts</span>  <span class="s2">&quot;entering iterator&quot;</span>
</span><span class='line'>                    <span class="nb">proc</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>                    <span class="nb">puts</span>  <span class="s2">&quot;exiting test method&quot;</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">def</span>  <span class="nf">test</span>
</span><span class='line'>                    <span class="n">iterator</span> <span class="p">{</span><span class="nb">puts</span> <span class="s2">&quot;entering proc&quot;</span><span class="p">;</span><span class="k">break</span><span class="p">)</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lambda类似于方法,因此,如果把一个break语句单独地放在那里,而不是出现在循环或者迭代方法中是说不通的.下面的语句,没有任何东西可以被break,你可能认为它会失败.
不过,在这种情况下,break的行为与return一样;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>            <span class="k">def</span>  <span class="nf">test</span>
</span><span class='line'>                    <span class="nb">puts</span> <span class="s2">&quot;entering test method&quot;</span>
</span><span class='line'>                    <span class="nb">lambda</span><span class="o">=</span><span class="nb">lambda</span><span class="p">{</span><span class="nb">puts</span> <span class="s2">&quot;entering lambda&quot;</span><span class="p">;</span><span class="k">break</span><span class="p">;</span><span class="nb">puts</span> <span class="s2">&quot;exiting    lambda&quot;</span><span class="p">}</span>
</span><span class='line'>                    <span class="nb">lambda</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>                    <span class="nb">puts</span> <span class="s2">&quot;exiting  test  method&quot;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>            <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2011/11/18/proc-vs-lambda//blog/page/13/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2011/11/18/flip-flop/">
		
			Flip-Flop</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-18T17:11:00+08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ruby/'>Ruby</a>


</div>
    </div>
		<p>今天学习到的一种比较新的,挺有趣的特性, 说新只是以前学JAVA和PHP的时候木有接触过.貌似Ruby的这一特性是从Perl那里继承而来,所以学习过Perl的程序员应该比较熟悉.</p>

<h2>flip-flop</h2>

<p>以下内容摘自<strong>《Ruby编程语言》</strong></p>

<blockquote><p>当..和&hellip;操作符被用在一个条件式,或者一个循环中时,它们不会创建Range对象.相反地,它们将创建一种特殊的布尔表达式,名为flip-flop.和比较以及相等表达式一样,一个flip-flop表达式的值也为true或者false.但是一个flip-flop表达式的特殊之处在于,它的值依赖于此前的求值结果,这就意味着flip-flop表达式具有与其关联的状态,所以你可能会认为一个flip-flop是一个某种类型的对象,但事实上flip-flop并不是对象,而是Ruby表达式.Ruby解释器在处理完一个flip-flop表达式之后,将为它在内部存储一个解析后的表现形式,其中就保存了该表达式的状态(只是作为一个布尔值).</p></blockquote>

<p>有了这些背景知识后,请看下面代码中的<code>flip-flop</code>.第一个<code>..</code>创建一个<code>Range</code>对象,第二个<code>..</code>则创建了一个<code>flip-flop</code>表达式:
<code>(1..10).each {|x| print x if x==3..x==5 }</code></p>

<blockquote><p>   在一个由条件式或者循环所构成的上下文中,一个flip-flop由两个通过..操作符相连的布尔表达式构成.除非其左侧表达式为true,否则一个flip-flop表达式就位false,而且在左侧表达式为true之前,它的值都会是false.</p>

<p>  一旦该表达式为true那么它就会&#8221;flips&#8221;到一个持久的true状态.它会保持该状态,而且对其后续的求值也返回true,直到其右侧的表达式为true为止.如果右侧表达式为 true了那么该flip-flop就会&#8221;flops&#8221;回一个持久的false状态,对其后续的求值也返回false,直到其左侧表达式再次成为true为止.</p>

<p>  在上面的代码例子中,该flip-flop被反复求值,相应的x的值也从1增加到10.起初,它的状态为false,而且在x等1和2的时候一直是false.当x等于3的时候,该flip-flop的状态就成为true.在x等于4和5的时候,该flip-flop的状态又回到了false,而且对于后续的x,它总是返回false.上述代码的执行结果是打印出345 .
可以使用..或&hellip;来编写flip-flop.起差别在于:当一个..flip-flop为true时,它会返回true,同时测试它的右侧表达式以决定是否需要将其内部状态设置回false；而对于&hellip;flip-flop来说,它等到下一次求值的时候才测试其右侧表达式.观察下面的代码:</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Prints &quot;3&quot;  .  Flips and flops back  when x==3</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">print</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">3</span><span class="o">.</span><span class="n">.x</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">}</span>
</span><span class='line'><span class="c1"># Print &quot;34&quot; .   Flis when x==3 and flops when x==4</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">print</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">x</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注:flip-flop其中一个意思是突变,flip和flop都有翻转的意思</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2011/11/18/flip-flop//blog/page/13/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2011/11/04/diary-that-team/">
		
			Diary:That Team</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2011-11-04T19:39:00+08:00" pubdate data-updated="true">Nov 4<span>th</span>, 2011</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/diary/'>Diary</a>, <a class='category' href='/blog/categories/jabber/'>Jabber</a>


</div>
    </div>
		<p>随着各种换届结束,这一年在志愿队就此接近尾声了&hellip;</p>

<p>回看上一篇,大一的那个志愿队！那个志愿队里的那个我！脑海又在逆流了…大一,我,我们,都过得很安逸,好像什么都未曾担心过,就好像刚进大学的懵懂那样！从以前被称为干事到这年被称为副部,大二这一年,真正的是在做事的一年…真正的为之着想的一年~~~真正成长的一年！</p>

<p>不像大一,小小的,有什么做错了也不怕,上面还有师兄师姐…大二了,虽说上面还有啊翠,不过,基本上也没啥好去劳烦她老人家了！都大二了,要学会自己承担各种事情了！ ！不过也算一个疏忽吧,有点把她架空了的感觉,很多时候作为老顶的她居然不知道我们做了些什么！！╮(╯▽╰)╭老翠,我们知错了！！舍不得老翠啊,以后没鸽在你身边自己好好照顾自己吧！！就你内小胃,比我还差还想满世界转！！！！<del>~除了老翠还有就是咱华姐那“销魂”的眼神！！以后估计没什么机会见到了！！！</del>(>_&lt;)~~~~</p>

<p>这一年,我像在跟志愿队谈恋爱,好多时候还会为之失眠！！从来没想过,会在大学为所谓的一些社团机构有这种feeling！！依旧是那句,比起应有的理性,我很不幸的拥有很多很多的感性因子！</p>

<p>这一年,直属的手下多了7个孩纸….好吧,虽然看上去我比你们还老,但是..貌似却只有燕初年龄是比我小的！！好吧,不拿年龄说事.这一年,我更多的出现是以志愿队的副部,而较少的作为一个联络部的副部吧！！所以,到最后,我问的那个问题,你们选择的都是玉燕而不是我.有些东西,我懂的…</p>

<p>这一年,也遗憾的是,没有做的尽善尽美！记得我跟吖宁说过的大学仅有的两件后悔事,看起来都很平常….而第二件,就是这年对下面的大一那群孩纸关心与交流太少了…不要觉得这句话很官方,至少我觉得我可以做得更好！！尤其是第一学期！！！当我意识到这一点的时候,这一学年就即将过去了.或许,来年我还可以救赎过去吧！！</p>

<p>虽说对小的们关心不够,不过还是很疼很溺爱他们滴(好像不矛盾吧?(<em>^__^</em>) )…不管他们做错什么,做得多坏多烂..从来不批他们的,很仁慈叻…不过仅限你们在大一吧,我是不会批大一的！不过未来你们大二了,要是 再有个行差搭错…我不会留情的哈！！！</p>

<p>其实,有个问题,其实想问大家很久了！！那几次的全体会上还是忍住没问,如果再给你们一次选择的机会,还会不会来到志愿队！?真诚的告诉我吧,大家！！    最后这段时间,我们几个副部很常在一起聊到,我们真的做的不好吗?可是如果相比起上一届,我觉得我们做的很不错的了！！！可是,为什么……</p>

<p>“如果让Luffy选择一个伙伴下船,那他会怎么做选择??”前不久冒出的一句！终于做了决定,现实不允许我改变,我也就只能忍痛割舍了！我能理解小贤当时的心情的！任谁离去心中也难受！好吧…我自己也是感情用事的人,却老是教你们不要感情用事,不要老把家挂嘴边！！！哎╮(╯▽╰)╭没办法啦,我就是那么没学长样的啦！！(都怪玉燕,好的不教把这教给大一！！)</p>

<p>这时代,一直在改变,各部门职能在不断完善,每年有人来了也有人走了,而在我,不变的只有对这个队伍的那份情！！！我和这支队伍一直都在成长,即使我现在大二了,但是在这学习获得的东西依旧很多!!!最重的,便是那份情！</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2011/11/04/diary-that-team//blog/page/13/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/12/" class="prev">Prev</a>
    
    
        <a href="/blog/page/14/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2014

    XguoX
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'xguox';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
